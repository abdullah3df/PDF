<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø®Ø¯Ù…Ø§Øª PDF & CV â€” Ù…Ù„Ù ÙˆØ§Ø­Ø¯ (Ù…ØµØ­Ù‘Ø­ Ù„Ù„Ø¬ÙˆØ§Ù„)</title>
  <meta name="description" content="Ø£Ø¯ÙˆØ§Øª PDF (Ø¯Ù…Ø¬ØŒ ØªÙ‚Ø³ÙŠÙ…ØŒ ØµÙˆØ±â†’PDF) ÙˆÙ…Ù†Ø´Ø¦ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© Ù…Ø¹ ØªØµØ¯ÙŠØ± PDF â€” ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.">

  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#93a4c7; --text:#e9eefb; --brand:#3aa9ff; --brand-2:#7ee787; --danger:#ff6b6b; --accent:#ffd166; --radius:18px; }
    *{box-sizing:border-box; -webkit-print-color-adjust:exact; print-color-adjust:exact}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0d1426 35%,#0a0f1d 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
    a{color:var(--brand)}
    .container{max-width:1180px;margin:auto;padding:24px}
    .nav{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo-badge{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%,var(--brand),#6dd3ff 40%,#0049ff)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{border:1px solid #223050;background:#0e1626;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:0.2s}
    .tab-btn[aria-selected="true"], .tab-btn:hover{background:linear-gradient(180deg,#12213b,#0e1626);border-color:#2a3a5d;box-shadow:0 0 0 2px rgb(58 169 255 / .18) inset}
    .grid{display:grid;grid-template-columns:1.15fr 1fr;gap:18px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0f1730,#0c1326);border:1px solid #243354;border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 6px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .panel{display:none}
    .panel.active{display:block;animation:fade .25s ease}
    @keyframes fade{from{opacity:.4;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .drop{border:1.5px dashed #35507f;border-radius:14px;padding:18px;text-align:center;background:#0e1628}
    .drop input{display:none}
    .drop label{display:inline-block;padding:10px 14px;border-radius:10px;background:#13213a;border:1px solid #2b3e66;cursor:pointer}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #2b3e66;background:#14223b;color:var(--text);cursor:pointer}
    .btn.brand{background:linear-gradient(180deg,#1a6eff,#1147ff);border-color:#2f55ff}
    .btn.good{background:linear-gradient(180deg,#15803d,#166534);border-color:#2e7d32}
    .btn.danger{background:linear-gradient(180deg,#b91c1c,#7f1d1d);border-color:#7f1d1d}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .list{margin:10px 0 0;padding:0;list-style:none;max-height:200px;overflow:auto;border:1px solid #223356;border-radius:12px}
    .list li{padding:8px 12px;border-bottom:1px solid #1d2a45;font-size:14px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .list li:last-child{border-bottom:0}
    .list .actions{display:flex;gap:6px}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field input,.field textarea, .field select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3e66;background:#0e1628;color:var(--text)}
    .field textarea{min-height:110px;resize:vertical}
    .cv{background:linear-gradient(180deg,#0e1529,#0c1222);border:1px solid #273455;border-radius:16px;padding:18px}
    .cv .sheet{width:794px; min-height:1123px;background:#ffffff;color:#0d1321;margin:auto;border-radius:8px;box-shadow:0 0 0 1px #e6eaf3 inset;overflow:hidden}
    @media (max-width: 820px){.cv .sheet{width:100%}}
    .cv-header{display:flex;gap:16px;align-items:center;padding:22px 26px;background:linear-gradient(90deg,#0b1220 0%,#133869 100%);color:#fff}
    .avatar{width:84px;height:84px;border-radius:50%;background:#d1d5db;overflow:hidden;border:3px solid rgba(255,255,255,.18)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .cv-body{display:grid;grid-template-columns:280px 1fr}
    @media (max-width: 720px){.cv-body{grid-template-columns:1fr}}
    .cv-side{background:#f6f8fc;padding:18px}
    .cv-main{padding:22px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#1e3a8a;font-size:12px;margin:0 4px 6px 0}
    .footer{margin-top:28px;text-align:center;font-size:12px;color:var(--muted)}

    /* Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªØµÙØ­ ÙƒØ®ÙŠØ§Ø± Ø¥Ø¶Ø§ÙÙŠ */
    @page { size: A4; margin: 10mm; }
    @media print {
      body { background: #ffffff; }
      .container, .nav { display:none !important; }
      .cv .sheet { box-shadow: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="logo" title="Ø®Ø¯Ù…Ø§Øª PDF & CV">
        <span class="logo-badge">ğŸ“„</span>
        <span>Ø®Ø¯Ù…Ø§Øª PDF & CV</span>
      </div>
      <div class="tabs" role="tablist" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
        <button class="tab-btn" data-tab="pdf" aria-selected="true">Ø£Ø¯ÙˆØ§Øª PDF</button>
        <button class="tab-btn" data-tab="cv">Ù…Ù†Ø´Ø¦ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</button>
        <button class="tab-btn" data-tab="about">Ø§Ù„ØªØ¹Ø±ÙŠÙ & Ø§Ù„ØªØ³Ø¹ÙŠØ±</button>
      </div>
    </div>

    <!-- PDF TOOLS PANEL -->
    <section id="panel-pdf" class="panel active">
      <div class="grid">
        <div class="card">
          <h2>Ø¯Ù…Ø¬ Ù…Ù„ÙØ§Øª PDF</h2>
          <p class="muted">Ø§Ø±ÙØ¹ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª PDF Ø¨ØªØ±ØªÙŠØ¨Ùƒ Ø«Ù… Ø§Ø¶ØºØ· Ø¯Ù…Ø¬. (ÙŠØ¯Ø¹Ù… ØªØ±ØªÙŠØ¨ Ù„Ù„Ù‡Ø§ØªÙ Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±)</p>
          <div class="drop" id="merge-drop">
            <input type="file" id="merge-input" accept="application/pdf" multiple>
            <label for="merge-input">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª PDF</label>
            <ul id="merge-list" class="list" aria-live="polite"></ul>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn brand" id="merge-btn">Ø¯Ù…Ù€Ø¬ ÙˆØªØ­Ù…ÙŠÙ„</button>
            <button class="btn" id="merge-clear">ØªÙØ±ÙŠØº</button>
          </div>
        </div>

        <div class="card">
          <h2>ØªÙ‚Ø³ÙŠÙ… Ù…Ù„Ù PDF</h2>
          <p class="muted">Ø£Ø¯Ø®Ù„ Ø§Ù„ØµÙØ­Ø§Øª Ù…Ø«Ù„: 1-3, 5, 8-9 (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</p>
          <div class="field">
            <input type="file" id="split-input" accept="application/pdf">
          </div>
          <div class="field">
            <label for="ranges">Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª</label>
            <input id="ranges" placeholder="Ù…Ø«Ø§Ù„: 1-2,4,7-9" />
          </div>
          <div class="row">
            <button class="btn brand" id="split-btn">ØªÙ‚Ø³ÙŠÙ… ÙˆØªØ­Ù…ÙŠÙ„</button>
            <button class="btn" id="split-clear">ØªÙØ±ÙŠØº</button>
          </div>
        </div>

        <div class="card">
          <h2>ØµÙˆØ± â†’ PDF</h2>
          <p class="muted">Ø­ÙˆÙ‘Ù„ ØµÙˆØ± JPG/PNG Ø¥Ù„Ù‰ PDF (ØµÙØ­Ø© Ù„ÙƒÙ„ ØµÙˆØ±Ø©) Ø¯Ø§Ø®Ù„ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
          <div class="field">
            <input type="file" id="img2pdf-input" accept="image/*" multiple>
          </div>
          <div class="row">
            <label>Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©:
              <select id="paper"><option value="a4">A4</option><option value="letter">Letter</option></select>
            </label>
            <label>Ù…Ù„Ø§Ø¡Ù…Ø©:
              <select id="fit"><option value="contain">Ø§Ø­ØªÙˆØ§Ø¡</option><option value="cover">Ù…Ù„Ø¡ Ø§Ù„ØµÙØ­Ø©</option></select>
            </label>
            <button class="btn good" id="img2pdf-btn">ØªØ­ÙˆÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„</button>
          </div>
        </div>

        <div class="card">
          <h2>Ù†ØµØ§Ø¦Ø­</h2>
          <ul>
            <li>ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª ØªØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ Ù…Ù„ÙØ§Øª).</li>
            <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ØªØ±ØªÙŠØ¨ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ø£Ùˆ Ø£Ø²Ø±Ø§Ø± â†‘ â†“.</li>
            <li>Ø¥Ø°Ø§ ÙØ´Ù„ Ù…Ù„Ù Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± â€” Ø£Ø²Ù„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- CV BUILDER PANEL -->
    <section id="panel-cv" class="panel">
      <div class="grid">
        <div class="card">
          <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h2>
          <div class="field"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="cv-name" placeholder="Ø§Ù„Ø§Ø³Ù…" /></div>
          <div class="field"><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input id="cv-title" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·ÙˆÙ‘Ø± ÙˆØ§Ø¬Ù‡Ø§Øª" /></div>
          <div class="field"><label>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ù‡Ù†ÙŠ</label><textarea id="cv-summary" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©â€¦"></textarea></div>
          <div class="field"><label>Ø§Ù„Ø®Ø¨Ø±Ø§Øª (ÙƒÙ„ Ø®Ø¨Ø±Ø© ÙÙŠ Ø³Ø·Ø±)</label><textarea id="cv-exp" placeholder="Ø§Ù„Ø´Ø±ÙƒØ© â€” Ø§Ù„Ù…Ù†ØµØ¨ â€” Ø§Ù„Ø³Ù†ÙˆØ§Øª"></textarea></div>
          <div class="field"><label>Ø§Ù„ØªØ¹Ù„ÙŠÙ…</label><textarea id="cv-edu" placeholder="Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© â€” Ø§Ù„Ø¯Ø±Ø¬Ø© â€” Ø§Ù„Ø³Ù†ÙˆØ§Øª"></textarea></div>
          <div class="field"><label>Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)</label><input id="cv-skills" placeholder="JavaScript, React, Weldingâ€¦" /></div>
          <div class="field"><label>Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="file" id="cv-photo" accept="image/*" /></div>
          <div class="row">
            <button class="btn brand" id="cv-generate">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button class="btn good" id="cv-download">ØªØ­Ù…ÙŠÙ„ PDF</button>
            <button class="btn" id="cv-clear">ØªÙØ±ÙŠØº</button>
          </div>
        </div>

        <div class="card cv">
          <h2 style="margin-bottom:10px">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</h2>
          <div id="cv-sheet" class="sheet" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©">
            <div class="cv-header">
              <div class="avatar" id="cv-avatar"></div>
              <div>
                <div id="cv-name-v" style="font-size:26px;font-weight:800">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
                <div id="cv-title-v" style="opacity:.9">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</div>
              </div>
            </div>
            <div class="cv-body">
              <aside class="cv-side">
                <h3 style="margin-top:0">Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</h3>
                <div id="cv-skills-v"></div>
              </aside>
              <main class="cv-main">
                <section>
                  <h3 style="margin-top:0">Ø§Ù„Ù…Ù„Ø®Øµ</h3>
                  <p id="cv-summary-v">Ø§ÙƒØªØ¨ Ù…Ù„Ø®ØµÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø¨Ø¥ÙŠØ¬Ø§Ø² ÙˆÙˆØ¶ÙˆØ­.</p>
                </section>
                <section>
                  <h3>Ø§Ù„Ø®Ø¨Ø±Ø§Øª</h3>
                  <div id="cv-exp-v"></div>
                </section>
                <section>
                  <h3>Ø§Ù„ØªØ¹Ù„ÙŠÙ…</h3>
                    <div id="cv-edu-v"></div>
                </section>
              </main>
            </div>
          </div>
          <div class="footer">* ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (LocalStorage).</div>
        </div>
      </div>
    </section>

    <!-- ABOUT PANEL -->
    <section id="panel-about" class="panel">
      <div class="grid" style="grid-template-columns:1fr">
        <div class="card">
          <h2>Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ØªØ³Ø¹ÙŠØ±</h2>
          <p class="muted">Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙŠØ¹Ù…Ù„ 100% Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆÙŠÙ…ÙƒÙ† Ù†Ø´Ø±Ù‡ Ø¹Ù„Ù‰ GitHub Pages Ø£Ùˆ Netlify Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Stripe.</p>
          <ul>
            <li><b>Ù…Ø¬Ø§Ù†ÙŠ:</b> Ø¯Ù…Ø¬ Ø­ØªÙ‰ 10 Ù…Ù„ÙØ§ØªØŒ ØªÙ‚Ø³ÙŠÙ… Ø­ØªÙ‰ 30 ØµÙØ­Ø©ØŒ Ù‚Ø§Ù„Ø¨ CV ÙˆØ§Ø­Ø¯.</li>
            <li><b>Ù…Ø¯ÙÙˆØ¹:</b> ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ + Ù‚ÙˆØ§Ù„Ø¨ CV Ø¥Ø¶Ø§ÙÙŠØ© + Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ.</li>
          </ul>
          <p>Ø§Ù„Ø®ØµÙˆØµÙŠØ©: Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©Ø› ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØªÙ… Ø¯Ø§Ø®Ù„ Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</p>
        </div>
      </div>
    </section>

    <div class="footer">Â© <span id="year"></span> â€” Ù…ÙˆÙ‚Ø¹ Ø®Ø¯Ù…Ø§Øª PDF & CV â€” Ù†Ø³Ø®Ø© Ù…ÙØ¹Ø§Ù„ÙØ¬Ø©</div>
  </div>

  <!-- Libraries (Ø¨Ø¯ÙˆÙ† Ø§Ø²Ø¯ÙˆØ§Ø¬): -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = { pdf: document.getElementById('panel-pdf'), cv: document.getElementById('panel-cv'), about: document.getElementById('panel-about') };
    tabs.forEach(btn=>{ btn.addEventListener('click',()=>{ tabs.forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true'); Object.values(panels).forEach(p=>p.classList.remove('active')); panels[btn.dataset.tab].classList.add('active'); }); });
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Helpers =====
    const $ = sel => document.querySelector(sel);
    function downloadBlob(bytes, filename, type){
      const blob = new Blob([bytes], {type: type || 'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // ===== MERGE PDF =====
    const mergeInput = document.getElementById('merge-input');
    const mergeList = document.getElementById('merge-list');
    const mergeFiles = [];

    function refreshMergeList(){
      mergeList.innerHTML = '';
      mergeFiles.forEach((f,idx)=>{
        const li = document.createElement('li');
        li.draggable = true;
        li.innerHTML = '<span>'+ (idx+1) +'. '+ f.name +' <small class="muted">('+ (f.size/1024/1024).toFixed(2) +' MB)</small></span>'+
                        '<span class="actions">\
            <button class="btn" data-action="up" data-i="'+idx+'" title="Ø£Ø¹Ù„Ù‰">â†‘</button>\
            <button class="btn" data-action="down" data-i="'+idx+'" title="Ø£Ø³ÙÙ„">â†“</button>\
            <button class="btn danger" data-action="del" data-i="'+idx+'">Ø­Ø°Ù</button></span>';
        mergeList.appendChild(li);
      });
    }
    mergeList.addEventListener('click', (e)=>{
      const i = e.target.dataset.i; const action = e.target.dataset.action; if(i===undefined) return;
      const idx = parseInt(i,10);
      if(action==='del'){ mergeFiles.splice(idx,1); }
      if(action==='up' && idx>0){ const m=mergeFiles.splice(idx,1)[0]; mergeFiles.splice(idx-1,0,m); }
      if(action==='down' && idx<mergeFiles.length-1){ const m=mergeFiles.splice(idx,1)[0]; mergeFiles.splice(idx+1,0,m); }
      refreshMergeList();
    });
    // Drag reorder + Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¥Ø³Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø§Øº
    let dragIdx=null;
    mergeList.addEventListener('dragstart', e=>{ const li=e.target.closest('li'); dragIdx = Array.prototype.indexOf.call(mergeList.children, li); });
    mergeList.addEventListener('dragover', e=>{ e.preventDefault(); });
    mergeList.addEventListener('drop', e=>{
      e.preventDefault();
      const targetLi = e.target.closest('li');
      if(!targetLi){ dragIdx=null; return; }
      const dropIdx = Array.prototype.indexOf.call(mergeList.children, targetLi);
      if(dragIdx>=0 && dropIdx>=0 && dragIdx!==dropIdx){
        const m=mergeFiles.splice(dragIdx,1)[0];
        mergeFiles.splice(dropIdx,0,m);
        refreshMergeList();
      }
      dragIdx=null;
    });

    mergeInput.addEventListener('change', (e)=>{ Array.prototype.forEach.call(e.target.files, f=>mergeFiles.push(f)); refreshMergeList(); });
    document.getElementById('merge-clear').onclick = ()=>{ mergeFiles.length=0; refreshMergeList(); };

    document.getElementById('merge-btn').onclick = async ()=>{
      if(!mergeFiles.length) { alert('Ø£Ø¶Ù Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{
        const PDFDocument = PDFLib.PDFDocument;
        const merged = await PDFDocument.create();
        for(const f of mergeFiles){
          const bytes = await f.arrayBuffer();
          const src = await PDFDocument.load(bytes, { ignoreEncryption: true });
          const pages = await merged.copyPages(src, src.getPageIndices());
          pages.forEach(p=>merged.addPage(p));
        }
        const out = await merged.save({ addDefaultPage:false });
        downloadBlob(out, 'merged_'+Date.now()+'.pdf');
      }catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¯Ù…Ø¬. Ø±Ø¨Ù…Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ùˆ ØªØ§Ù„Ù.'); }
    };

    // ===== SPLIT PDF =====
    document.getElementById('split-clear').onclick = ()=>{ document.getElementById('split-input').value=''; document.getElementById('ranges').value=''; };

    function parseRanges(str, total){
      const set = [];
      const seen = {};
      str.split(',').map(s=>s.trim()).filter(Boolean).forEach(part=>{
        const dash = part.indexOf('-');
        let a, b;
        if(dash>-1){ a = parseInt(part.slice(0,dash),10); b = parseInt(part.slice(dash+1),10); }
        else { a = parseInt(part,10); b = a; }
        if(isNaN(a) || isNaN(b)) return;
        const from = Math.min(a,b), to = Math.max(a,b);
        for(let i=from;i<=to;i++){
          if(i>=1 && i<=total && !seen[i]){ seen[i]=true; set.push(i-1); }
        }
      });
      set.sort((x,y)=>x-y);
      return set;
    }

    document.getElementById('split-btn').onclick = async ()=>{
      const file = document.getElementById('split-input').files && document.getElementById('split-input').files[0];
      const ranges = document.getElementById('ranges').value.trim();
      if(!file) { alert('Ø§Ø®ØªØ± Ù…Ù„Ù PDF'); return; }
      try{
        const bytes = await file.arrayBuffer();
        const PDFDocument = PDFLib.PDFDocument;
        const src = await PDFDocument.load(bytes, { ignoreEncryption:true });
        const total = src.getPageCount();
        const indices = ranges ? parseRanges(ranges, total) : src.getPageIndices();
        if(!indices.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙØ­Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Ø·Ø§Ù‚'); return; }
        const outDoc = await PDFDocument.create();
        const pages = await outDoc.copyPages(src, indices);
        pages.forEach(p=>outDoc.addPage(p));
        const out = await outDoc.save();
        downloadBlob(out, 'split_'+Date.now()+'.pdf');
      }catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªÙ‚Ø³ÙŠÙ…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø­Ù…ÙŠ ÙˆØ£Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ ØµØ­ÙŠØ­.'); }
    };

    // ===== IMAGES â†’ PDF =====
    const sizeMap = { a4:{ w:595.28, h:841.89 }, letter:{ w:612, h:792 } };

    function downscaleImage(img, maxSide=2200){
      const max = Math.max(img.width, img.height);
      if(max <= maxSide) return img;
      const ratio = maxSide / max;
      const c = document.createElement('canvas');
      c.width = Math.round(img.width * ratio);
      c.height = Math.round(img.height * ratio);
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, c.width, c.height);
      const scaled = new Image();
      scaled.src = c.toDataURL('image/jpeg', 0.9);
      return scaled;
    }

    document.getElementById('img2pdf-btn').onclick = async ()=>{
      const input = document.getElementById('img2pdf-input');
      const files = input.files;
      if(!files || !files.length){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const paper = document.getElementById('paper').value;
      const fit = document.getElementById('fit').value; // contain | cover
      const jsPDF = window.jspdf.jsPDF;
      try{
        const pdf = new jsPDF({ unit:'pt', format:[sizeMap[paper].w, sizeMap[paper].h], orientation:'portrait' });
        for(let i=0;i<files.length;i++){
          const imgRaw = await fileToImage(files[i]);
          const img = await new Promise(res=>{
            const s = downscaleImage(imgRaw, 2200);
            if (s.complete) res(s); else s.onload = ()=>res(s);
          });
          if(i>0) pdf.addPage([sizeMap[paper].w, sizeMap[paper].h]);
          const rect = fitRect(img.width, img.height, sizeMap[paper].w, sizeMap[paper].h, fit);
          pdf.addImage(imageToDataURL(img), 'JPEG', rect.x, rect.y, rect.w, rect.h);
        }
        pdf.save('images_'+Date.now()+'.pdf');
      }catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­ÙˆÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ ØµÙˆØ±Ù‹Ø§ Ø£ØµØºØ±.'); }
    };

    function fileToImage(file){
      return new Promise(function(resolve,reject){
        const reader = new FileReader();
        reader.onload = function(){ const img = new Image(); img.onload=function(){ resolve(img); }; img.onerror=reject; img.src = reader.result; };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    function imageToDataURL(img){
      const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
      return c.toDataURL('image/jpeg', 0.92);
    }
    function fitRect(iw, ih, cw, ch, mode){
      const ir = iw/ih, cr = cw/ch; let w,h;
      const cover = mode === 'cover';
      if((!cover && ir>cr) || (cover && ir<cr)){ w=cw; h=w/ir; } else { h=ch; w=h*ir; }
      const x = (cw - w)/2, y = (ch - h)/2; return {x:x, y:y, w:w, h:h};
    }

    // ===== CV BUILDER =====
    function slugifyName(s){
      const parts = (s || '').trim().split(' ').filter(Boolean);
      return parts.join('_') || 'CV';
    }
    function splitLines(s){
      const NL = String.fromCharCode(10);
      return (s||'').split(NL).filter(x=>x && x.trim().length);
    }
    const store = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k, def)=> { try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }catch(e){ return def; } };

    function syncPreview(){
      const name = (document.getElementById('cv-name').value || '').trim() || 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„';
      const title = (document.getElementById('cv-title').value || '').trim() || 'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ';
      const summary = (document.getElementById('cv-summary').value || '').trim() || 'Ø§ÙƒØªØ¨ Ù…Ù„Ø®ØµÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠ Ø¨Ø¥ÙŠØ¬Ø§Ø² ÙˆÙˆØ¶ÙˆØ­.';
      const exp = splitLines(document.getElementById('cv-exp').value);
      const edu = splitLines(document.getElementById('cv-edu').value);
      const skills = (document.getElementById('cv-skills').value || '').split(',').map(s=>s.trim()).filter(Boolean);

      document.getElementById('cv-name-v').textContent = name;
      document.getElementById('cv-title-v').textContent = title;
      document.getElementById('cv-summary-v').textContent = summary;

      const expV = document.getElementById('cv-exp-v'); expV.innerHTML='';
      exp.forEach(line=>{ const p=document.createElement('p'); p.textContent=line; expV.appendChild(p); });
      const eduV = document.getElementById('cv-edu-v'); eduV.innerHTML='';
      edu.forEach(line=>{ const p=document.createElement('p'); p.textContent=line; eduV.appendChild(p); });
      const skillsV = document.getElementById('cv-skills-v'); skillsV.innerHTML='';
      skills.forEach(s=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=s; skillsV.appendChild(span); });

      store('cv-data',{name,title,summary,exp,edu,skills,photo:load('cv-photo',null)});
    }

    document.getElementById('cv-generate').onclick = syncPreview;
    document.getElementById('cv-clear').onclick = function(){
      ['cv-name','cv-title','cv-summary','cv-exp','cv-edu','cv-skills'].forEach(id=>{ document.getElementById(id).value=''; });
      localStorage.removeItem('cv-data'); localStorage.removeItem('cv-photo');
      document.getElementById('cv-avatar').innerHTML='';
      syncPreview();
    };

    // ===== ØªÙ†Ø²ÙŠÙ„ CV ÙƒÙ€ PDF â€” Ù…ÙØ­Ø³Ù‘ÙÙ† Ù„Ù„Ø¬ÙˆØ§Ù„ Ù…Ø¹ Ù…Ø³Ø§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ =====
    document.getElementById('cv-download').onclick = async function(){
      const sheet = document.getElementById('cv-sheet');
      const nameInput = document.getElementById('cv-name');
      const fileName = (slugifyName((nameInput && nameInput.value) || 'CV') + '.pdf');

      if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(_) {} }

      // Ù†Ø³Ø®Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ viewport (Ø¨Ø¯ÙˆÙ† Ø´ÙØ§ÙÙŠØ©)
      const clone = sheet.cloneNode(true);
      clone.setAttribute('dir','rtl');
      Object.assign(clone.style, {
        position: 'fixed',
        left: '0',
        top: '0',
        transform: 'none',
        filter: 'none',
        visibility: 'hidden',     // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… opacity:0
        pointerEvents: 'none',
        background: '#ffffff',
        width: sheet.offsetWidth + 'px',
        display: 'block',
        zIndex: 999999
      });
      document.body.appendChild(clone);
      void clone.offsetHeight;

      const cleanup = ()=>{ try{ clone.remove(); }catch(_){} };

      try{
        // scale Ø£Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        const scale = /Mobi|Android/i.test(navigator.userAgent) ? 1.2 : 2;

        const canvas = await window.html2canvas(clone, {
          scale,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          windowWidth: clone.scrollWidth || clone.offsetWidth,
          windowHeight: clone.scrollHeight || clone.offsetHeight
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        const pdf = new window.jspdf.jsPDF({ unit:'pt', format:'a4', orientation:'portrait' });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageW / canvas.width, pageH / canvas.height);
        const renderW = canvas.width * ratio, renderH = canvas.height * ratio;
        const offsetX = (pageW - renderW) / 2, offsetY = (pageH - renderH) / 2;

        pdf.addImage(imgData, 'JPEG', offsetX, offsetY, renderW, renderH);
        pdf.save(fileName);
      } catch(err){
        console.error("Ø®Ø·Ø£ html2canvas:", err);
        // Ø§Ø­ØªÙŠØ§Ø·ÙŠ: html2pdf Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£Ø¨Ø·Ø£ Ù„ÙƒÙ†Ù‡ Ø£Ø®Ù)
        if (window.html2pdf) {
          await window.html2pdf().set({
            filename: fileName,
            margin: 0,
            image: { type:'jpeg', quality: 0.95 },
            html2canvas: { scale: 1, useCORS:true, backgroundColor:'#ffffff' },
            jsPDF: { unit:'pt', format:'a4', orientation:'portrait' }
          }).from(clone).save();
        } else {
          alert("ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ PDF Ø­ØªÙ‰ Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.");
        }
      } finally {
        cleanup();
      }
    };

    // Photo upload
    document.getElementById('cv-photo').addEventListener('change', function(e){
      const file = e.target.files && e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = function(){ localStorage.setItem('cv-photo', reader.result); renderAvatar(); };
      reader.readAsDataURL(file);
    });
    function renderAvatar(){
      const data = localStorage.getItem('cv-photo');
      const box = document.getElementById('cv-avatar');
      box.innerHTML = data ? '<img src="'+data+'" alt=""/>' : '';
    }

    // Load persisted on start
    (function(){
      const data = (()=>{
        try{ const v = localStorage.getItem('cv-data'); return v? JSON.parse(v): null; }catch(_){ return null; }
      })();
      if(data){
        document.getElementById('cv-name').value = data.name || '';
        document.getElementById('cv-title').value = data.title || '';
        document.getElementById('cv-summary').value = data.summary || '';
        document.getElementById('cv-exp').value = (data.exp || []).join(String.fromCharCode(10));
        document.getElementById('cv-edu').value = (data.edu || []).join(String.fromCharCode(10));
        document.getElementById('cv-skills').value = (data.skills || []).join(', ');
      }
      renderAvatar();
      syncPreview();
    })();
  </script>
</body>
</html>
